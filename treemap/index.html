<!--
Copyright (c) 2021 LMU Munich Geometry Processing Authors. All rights reserved.
Created by Changkun Ou <https://changkun.de>.

Use of this source code is governed by a GNU GPLv3 license that can be found
in the LICENSE file.
-->

<!DOCTYPE html>
<meta charset="utf-8">
<script src="https://d3js.org/d3.v6.js"></script>
<style>
body {
    margin: 10;
    padding: 0;
}
</style>
<select name="methods" id="methods" onchange="methodChanged(this)">
<option value="sliceAndDice">a) Slice-and-Dice</option>
<option value="squarified">b) Squarified</option>
</select>

<div id="infovis"></div>
<script>
const margin = {
    top:    10,
    right:  10,
    bottom: 10,
    left:   10,
};
const width = 800
const height = 800

function methodChanged(el) {
    const value = el.options[el.selectedIndex].value;
    createTreemap(value);
}

createTreemap("sliceAndDice");

function dice(parent, x0, y0, x1, y1) {
  var nodes = parent.children,
      node,
      i = -1,
      n = nodes.length,
      k = parent.value && (x1 - x0) / parent.value;

  while (++i < n) {
    node = nodes[i], node.y0 = y0, node.y1 = y1;
    node.x0 = x0, node.x1 = x0 += node.value * k;
  }
}
function slice(parent, x0, y0, x1, y1) {
  var nodes = parent.children,
      node,
      i = -1,
      n = nodes.length,
      k = parent.value && (y1 - y0) / parent.value;

  while (++i < n) {
    node = nodes[i], node.x0 = x0, node.x1 = x1;
    node.y0 = y0, node.y1 = y0 += node.value * k;
  }
}
function sliceAndDice(parent, x0, y0, x1, y1) {
    (parent.depth & 1 ? dice : slice)(parent, x0, y0, x1, y1);
};
function squarify(parent, x0, y0, x1, y1) {
    squarifyRatio(1, parent, x0, y0, x1, y1);
}
function squarifyRatio(ratio, parent, x0, y0, x1, y1) {
  var rows = [],
      nodes = parent.children,
      row,
      nodeValue,
      i0 = 0,
      i1 = 0,
      n = nodes.length,
      dx, dy,
      value = parent.value,
      sumValue,
      minValue,
      maxValue,
      newRatio,
      minRatio,
      alpha,
      beta;

  while (i0 < n) {
    dx = x1 - x0, dy = y1 - y0;

    do sumValue = nodes[i1++].value; while (!sumValue && i1 < n);
    minValue = maxValue = sumValue;
    alpha = Math.max(dy / dx, dx / dy) / (value * ratio);
    beta = sumValue * sumValue * alpha;
    minRatio = Math.max(maxValue / beta, beta / minValue);

    for (; i1 < n; ++i1) {
      sumValue += nodeValue = nodes[i1].value;
      if (nodeValue < minValue) minValue = nodeValue;
      if (nodeValue > maxValue) maxValue = nodeValue;
      beta = sumValue * sumValue * alpha;
      newRatio = Math.max(maxValue / beta, beta / minValue);
      if (newRatio > minRatio) { sumValue -= nodeValue; break; }
      minRatio = newRatio;
    }

    rows.push(row = {value: sumValue, dice: dx < dy, children: nodes.slice(i0, i1)});
    if (row.dice) dice(row, x0, y0, x1, value ? y0 += dy * sumValue / value : y1);
    else slice(row, x0, y0, value ? x0 += dx * sumValue / value : x1, y1);
    value -= sumValue, i0 = i1;
  }

  return rows;
}

function createTreemap(method) {
    let drawMethod;
    switch (method) {
    case "sliceAndDice":
        drawMethod = sliceAndDice
        break;
    case "squarified":
        drawMethod = squarify;
        break;
    case "strip":
        drawMethod = d3.treemapResquarify.ratio(1);
        break;
    }

    d3.select("#infovis").selectAll("svg").remove();
    const svg = d3.select("#infovis")
        .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", `translate(${margin.left}, ${margin.top})`);

    const data = {
        "children":[
            {
                "name": "8",
                "value": 8,
                "colorname":"level2",
            },
            {
                "name": "",
                "children":[
                    {"name":"2","value":2,"colorname":"level1"},
                    {"name":"2","value":2,"colorname":"level2"},
                    {"name":"2","value":2,"colorname":"level3"},
                    {"name":"3","value":3,"colorname":"level4"},
                    {"name":"1","value":1,"colorname":"level5"},
                ],
                "colorname":"level1",
            },
            {
                "name": "12",
                "value": 12,
                "colorname":"level1",
            },
            {
                "name": "",
                "children":[
                    {"name":"40","value":40,"colorname":"level5"},
                    {
                        "name": "",
                        "children":[
                            {"name":"11","value":11,"colorname":"level3"},
                            {"name":"8","value":8,"colorname":"level2"},
                            {"name":"6","value":6,"colorname":"level1"},
                        ],
                        "colorname":"level1",
                    },
                    {"name":"5","value":5,"colorname":"level4"},
                ],
                "colorname":"level1",
            },
        ],
        "name":"root",
    }

    const root = d3.hierarchy(data).sum(function(d){ return d.value})
    d3.treemap().size([width, height])
    .tile(drawMethod)(root);


    const color = d3.scaleOrdinal()
        .domain(["level1", "level2", "level3", "level4", "level5"])
        .range([ "#003a8c", "#0050b3", "#1890ff", "#69c0ff", "#bae7ff"])

    svg
    .selectAll("rect")
    .data(root.leaves())
    .join("rect")
        .attr('x', function (d) { return d.x0; })
        .attr('y', function (d) { return d.y0; })
        .attr('width', function (d) { return d.x1 - d.x0; })
        .attr('height', function (d) { return d.y1 - d.y0; })
        .style("stroke", "black")
        .style("fill", function(d){
            console.log(d.data.colorname, color(d.data.colorname))
            return color(d.data.colorname)}
        )

    svg
    .selectAll("text")
    .data(root.leaves())
    .join("text")
        .attr("x", function(d){ return d.x0+5})
        .attr("y", function(d){ return d.y0+20})
        .text(function(d){ return d.data.name })
        .attr("font-size", "15px")
        .attr("fill", "white")
}
</script>